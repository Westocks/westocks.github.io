<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WESTOCKS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDcgWQyY9QewcZ5v1QLC6rRD9AWfqicKgQ",
  authDomain: "westocks-5184b.firebaseapp.com",
  databaseURL: "https://westocks-5184b-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "westocks-5184b",
  storageBucket: "westocks-5184b.firebasestorage.app",
  messagingSenderId: "265102905724",
  appId: "1:265102905724:web:52c5c7365df3929a32d4f9",
  measurementId: "G-RSMLRH5ZTL"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<style>
html,body{margin:0;height:100%;font-family:Arial,sans-serif;color:white}
body{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(270deg,#0f2027,#203a43,#2c5364);background-size:600% 600%;animation:bg 18s ease infinite}
@keyframes bg{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.container{max-width:1000px;width:100%;background:rgba(0,0,0,.45);padding:20px;border-radius:16px}
h1{text-align:center;letter-spacing:4px}
button{padding:6px 12px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;margin:2px;}
.buy{background:white;color:black}
.sell{background:#ffb3b3;color:black}
.toggle{background:rgba(255,255,255,.2);color:white}
.stock{margin-top:16px;padding:14px;background:rgba(255,255,255,.08);border-radius:12px}
.canvas-container{width:100%;overflow-x:auto;} /* scrollable container */
canvas{height:140px;background:rgba(0,0,0,.3);border-radius:8px;display:block;}
#message{margin-top:10px;font-size:14px;opacity:.9}
#activeCount{text-align:center;margin-bottom:10px;font-size:16px;opacity:.9}
#portfolio{margin-top:10px;text-align:center;font-size:16px;opacity:.9}
.profit{color:lime;}
.loss{color:red;}
@keyframes pulse{0%{transform:scale(1);opacity:0.8}50%{transform:scale(1.1);opacity:1}100%{transform:scale(1);opacity:0.8}}
#activeCount.flash{animation:pulse 0.5s ease}
</style>
</head>
<body>

<div class="container">
  <h1>WESTOCKS</h1>
  <div id="activeCount">Active Players: 0</div>
  <div id="start">
    <p style="text-align:center">Demo only — not real money</p>
    <div style="text-align:center">
      <button class="buy" onclick="start()">Start Investing</button>
    </div>
  </div>
  <div id="market" style="display:none">
    <div>Cash: $<span id="cash">1000.00</span></div>
    <div id="portfolio">Portfolio Value: $<span id="portfolioValue">1000.00</span></div>
    <div id="message"></div>
    <div id="stocks"></div>
  </div>
</div>

<script>
//////////////////// ACTIVE PLAYER COUNTER ////////////////////
const userRef = db.ref('activePlayers');
const userId = Math.random().toString(36).substring(2)+Date.now();
const myRef = userRef.child(userId);
myRef.set(true).catch(console.error);
window.addEventListener('beforeunload',()=>myRef.remove());
userRef.on('value', snapshot=>{
  const count = snapshot.numChildren();
  const el = document.getElementById('activeCount');
  el.innerText = `Active Players: ${count}`;
  el.classList.add('flash');
  setTimeout(()=>el.classList.remove('flash'),500);
});

//////////////////// STOCK SIMULATOR ////////////////////
let cash = parseFloat(localStorage.getItem('cash')) || 1000;
const stocks = {
  NOVA:{price:120,shares:parseFloat(localStorage.getItem('NOVA_shares'))||0,history:[120],buyPrice:null,show:false},
  ORBX:{price:80,shares:parseFloat(localStorage.getItem('ORBX_shares'))||0,history:[80],buyPrice:null,show:false},
  ZENT:{price:200,shares:parseFloat(localStorage.getItem('ZENT_shares'))||0,history:[200],buyPrice:null,show:false}
};

function start(){document.getElementById("start").style.display="none";document.getElementById("market").style.display="block";render()}

function updatePrices(){
  for(const s in stocks){
    let st = stocks[s];
    let change = (Math.random()-0.5)*0.05;
    st.price=Math.max(1, +(st.price*(1+change)).toFixed(2));
    st.history.push(st.price);
    if(st.history.length>200) st.history.shift();
  }
  render();
}
setInterval(updatePrices,2500);

///////////////////// BUY/SELL ////////////////////
function buy(sym){let amt=parseFloat(prompt("Enter USD amount to buy")); if(isNaN(amt)||amt<=0||amt>cash){showMsg("Invalid amount"); return} let st=stocks[sym]; let shares=amt/st.price; cash-=amt; st.shares+=shares; st.buyPrice=st.price; saveSession(); showMsg(`Bought ${shares.toFixed(3)} ${sym}`); render()}
function buyAll(sym){if(cash<=0)return; let st=stocks[sym]; let shares=cash/st.price; st.shares+=shares; st.buyPrice=st.price; cash=0; saveSession(); showMsg(`Bought ALL ${sym}`); render()}
function sell(sym){let qty=parseFloat(prompt("Enter shares to sell")); let st=stocks[sym]; if(isNaN(qty)||qty<=0||qty>st.shares){showMsg("Invalid share amount"); return} st.shares-=qty; cash+=qty*st.price; saveSession(); showMsg(`Sold ${qty.toFixed(3)} ${sym}`); render()}
function sellAll(sym){let st=stocks[sym]; if(st.shares<=0)return; cash+=st.shares*st.price; st.shares=0; saveSession(); showMsg(`Sold ALL ${sym}`); render()}
function toggleGraph(sym){stocks[sym].show=!stocks[sym].show; render()}

///////////////////// RENDER ////////////////////
function render(){
  document.getElementById("cash").innerText=cash.toFixed(2);
  let portfolio=cash;
  for(const s in stocks) portfolio += stocks[s].shares*stocks[s].price;
  let portfolioEl=document.getElementById("portfolioValue");
  let oldValue=parseFloat(portfolioEl.innerText);
  portfolioEl.innerText=portfolio.toFixed(2);
  portfolioEl.style.color=portfolio>oldValue?'lime':portfolio<oldValue?'red':'white';
  setTimeout(()=>portfolioEl.style.color='white',400);

  let out="";
  for(const s in stocks){
    let st=stocks[s];
    let avg=(st.history.reduce((a,b)=>a+b,0)/st.history.length).toFixed(2);
    let pl=st.shares*(st.price-(st.buyPrice||st.price));
    let plClass=pl>=0?'profit':'loss';
    let plText=st.shares>0?`<span class="${plClass}">${pl>=0?'+':''}${pl.toFixed(2)}</span>`:'';
    let lastPrice=st.history[st.history.length-2]||st.price;
    let color = st.price>lastPrice?'lime':st.price<lastPrice?'red':'white';
    let canvasWidth = Math.max(800, st.history.length*12); // scrollable if long
    out+=`<div class="stock" title="Min:${Math.min(...st.history)}, Max:${Math.max(...st.history)}, Avg:${avg}">
      <strong>${s}</strong> — <span style="color:${color}">$${st.price}</span><br>
      Shares: ${st.shares.toFixed(3)} | P/L: ${plText}<br>
      <button class="buy" onclick="buy('${s}')">Buy</button>
      <button class="buy" onclick="buyAll('${s}')">Buy All</button>
      <button class="sell" onclick="sell('${s}')">Sell</button>
      <button class="sell" onclick="sellAll('${s}')">Sell All</button>
      <button class="toggle" onclick="toggleGraph('${s}')">Graph</button>
      <div class="canvas-container"><canvas id="g-${s}" width="${canvasWidth}" height="140" style="display:${st.show?'block':'none'}"></canvas></div>
    </div>`;
  }
  document.getElementById("stocks").innerHTML=out;

  for(const s in stocks) if(stocks[s].show) drawGraph(s);
}

///////////////////// DRAW GRAPH WITH AXES ////////////////////
function drawGraph(sym){
  let c=document.getElementById("g-"+sym), ctx=c.getContext("2d"), data=stocks[sym].history;
  ctx.clearRect(0,0,c.width,c.height);
  
  let min=Math.min(...data), max=Math.max(...data);
  
  // Y-axis
  ctx.strokeStyle='white';
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(40,0);
  ctx.lineTo(40,c.height);
  ctx.stroke();
  
  // X-axis
  ctx.beginPath();
  ctx.moveTo(40,c.height-20);
  ctx.lineTo(c.width,c.height-20);
  ctx.stroke();
  
  ctx.fillStyle='white';
  ctx.font='12px Arial';
  ctx.textAlign='right';
  
  // Y labels & grid
  for(let i=0;i<=5;i++){
    let y = i*(c.height-30)/5;
    let price = (max - i*(max-min)/5).toFixed(2);
    ctx.fillText(price,35,y+5);
    ctx.beginPath();
    ctx.moveTo(40,y);
    ctx.lineTo(c.width,y);
    ctx.strokeStyle='rgba(255,255,255,0.1)';
    ctx.stroke();
  }
  
  // X labels
  ctx.textAlign='center';
  for(let i=0;i<data.length;i+=10){
    let x = 40 + (i/(data.length-1))*(c.width-40);
    ctx.fillText(i,x,c.height-5);
  }
  
  // Stock line
  ctx.strokeStyle='white';
  ctx.lineWidth=2;
  ctx.beginPath();
  data.forEach((p,i)=>{
    let x = 40 + (i/(data.length-1))*(c.width-40);
    let y = (c.height-20) - (p-min)/(max-min+0.01)*(c.height-30);
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  });
  ctx.stroke();
  
  // Shaded area
  ctx.lineTo(c.width,c.height-20); ctx.lineTo(40,c.height-20);
  ctx.fillStyle='rgba(255,255,255,0.1)'; ctx.fill();
  
  // Latest price
  let lastY = (c.height-20) - (data[data.length-1]-min)/(max-min+0.01)*(c.height-30);
  ctx.beginPath(); ctx.arc(c.width,lastY,3,0,Math.PI*2); ctx.fillStyle='yellow'; ctx.fill();
  
  // Buy price line
  if(stocks[sym].buyPrice){
    let y = (c.height-20) - (stocks[sym].buyPrice-min)/(max-min+0.01)*(c.height-30);
    ctx.strokeStyle="lime";
    ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(c.width,y); ctx.stroke();
  }
}

function showMsg(t){document.getElementById("message").innerText=t}

///////////////////// SESSION STORAGE ////////////////////
function saveSession(){
  localStorage.setItem('cash',cash);
  for(const s in stocks) localStorage.setItem(s+'_shares',stocks[s].shares);
}

///////////////////// KEYBOARD SHORTCUTS ////////////////////
document.addEventListener('keydown', e=>{
  if(e.key==='1') buy('NOVA');
  if(e.key==='2') buy('ORBX');
  if(e.key==='3') buy('ZENT');
});
</script>
</body>
</html>
