<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WESTOCKS</title>
<style>
  html,body { height:100%; margin:0; font-family:Inter, Arial, sans-serif; overflow:hidden; }
  body {
    color:white;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    background: linear-gradient(270deg,#0f172a,#022b3a,#0f172a);
    background-size:600% 600%;
    animation: gradientAnimation 18s ease infinite;
  }
  @keyframes gradientAnimation {
    0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}
  }

  /* layout */
  .app {
    width:1100px;
    height:700px;
    position:relative;
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:20px;
    padding:24px;
    box-sizing:border-box;
    z-index:2;
  }

  .main {
    background: rgba(255,255,255,0.04);
    border-radius:14px;
    padding:28px;
    box-shadow: 0 6px 30px rgba(0,0,0,0.45);
    position:relative;
    overflow:auto;
  }
  .side {
    background: rgba(255,255,255,0.04);
    border-radius:14px;
    padding:16px;
    box-shadow: 0 6px 30px rgba(0,0,0,0.45);
    overflow:auto;
  }

  h1 { margin:6px 0 18px 0; letter-spacing:3px; font-size:34px; }
  p.lead { margin:6px 0 18px 0; opacity:0.9; }

  .controls { margin-top:18px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  input[type=number], select { padding:10px; font-size:16px; border-radius:8px; border:none; min-width:170px; }
  .btn { padding:10px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:700; }
  .btn-primary { background:white; color:#061124; }
  .btn-ghost { background: rgba(255,255,255,0.06); color:white; border:1px solid rgba(255,255,255,0.06); }

  .help-area { margin-top:14px; }
  .market-list { display:flex; flex-direction:column; gap:12px; margin-top:12px; }
  .stock { display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); }
  .stock .meta { display:flex; gap:12px; align-items:center; }
  .small { font-size:13px; opacity:0.9; }

  .portfolio { margin-top:18px; }
  .portfolio .row { display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px; }

  /* help modal-ish */
  #helpBox {
    display:none;
    position:fixed;
    z-index:999;
    left:50%; top:50%;
    transform:translate(-50%,-50%);
    background:rgba(6,17,36,0.95);
    color:white;
    padding:20px;
    border-radius:10px;
    max-width:600px;
    box-shadow:0 10px 40px rgba(0,0,0,0.6);
  }
  #helpBox button { margin-top:12px; }

  /* star canvas is full-screen behind UI */
  canvas#stars { position:fixed; left:0; top:0; width:100%; height:100%; z-index:1; pointer-events:none; }

  footer.note { position:absolute; bottom:12px; left:24px; font-size:12px; opacity:0.7; }
</style>
</head>
<body>
<canvas id="stars"></canvas>

<div class="app" role="application" aria-label="Westocks app">
  <div class="main">
    <h1>WESTOCKS</h1>
    <p class="lead">Welcome — click the button to start. (Demo only.)</p>

    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <button id="askBtn" class="btn btn-primary">Click me</button>
      <button id="helpBtn" class="btn btn-ghost">Help</button>
    </div>

    <div class="controls" id="askArea" style="display:none;">
      <input id="amountInput" type="number" placeholder="Enter amount" step="0.01" />
      <select id="currencySelect" title="Currency">
        <option value="USD">$ USD</option>
        <option value="EUR">€ EUR</option>
        <option value="GBP">£ GBP</option>
      </select>
      <button id="buyBtn" class="btn btn-primary">Buy</button>
      <div style="margin-left:auto; text-align:right;">
        <div class="small">Cash balance</div>
        <div id="cashBal" style="font-weight:700; margin-top:4px;">$ 0.00</div>
      </div>
    </div>

    <div class="help-area" id="helpArea" style="display:none;">
      <!-- hidden fallback help text if not using modal -->
    </div>

    <div class="portfolio" id="portfolioArea">
      <h3 style="margin-bottom:8px;">Portfolio (global)</h3>
      <div id="portfolioList">
        <div class="small">Loading portfolio…</div>
      </div>
    </div>

    <footer class="note">Demo allows negative balances. Do not use real money with this demo.</footer>
  </div>

  <aside class="side">
    <h3>Stock Market</h3>
    <div class="small">Prices update every few seconds (shared across users).</div>

    <div class="market-list" id="marketList">
      <!-- stocks injected here -->
    </div>

    <hr style="margin-top:14px; border-color: rgba(255,255,255,0.06);" />
    <div class="small" style="margin-top:10px;">
      This demo stores market & portfolio state in Firebase Firestore. Replace config below with your Firebase project settings.
    </div>
  </aside>
</div>

<!-- help modal -->
<div id="helpBox" role="dialog" aria-modal="true">
  <strong>Help</strong>
  <p style="margin-top:8px;">
    Westocks is an investing business. This website is made to help investors invest in us.
    Then we use your money and invest it, giving your money back and more.
  </p>
  <button id="closeHelp" class="btn btn-primary">Close</button>
</div>

<!-- Firebase (compat) - using CDN compat build for simplicity -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* =========================
   Configuration - REPLACE
   =========================
   1) Create a Firebase project at https://console.firebase.google.com/
   2) Create a Firestore database (start in test mode for demo)
   3) Copy your project's config object below and paste into firebaseConfig
   4) IMPORTANT: For a demo you can use test mode, but for production set secure rules and authentication.
*/
const firebaseConfig = {
  apiKey: "REPLACE_ME",
  authDomain: "REPLACE_ME",
  projectId: "REPLACE_ME",
  // rest of your config...
};

if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "REPLACE_ME") {
  console.warn("Firebase config not set — Firestore will not work until you replace config.");
}

/* Initialize Firebase */
try {
  firebase.initializeApp(firebaseConfig);
  var db = firebase.firestore();
} catch (e) {
  console.warn("Firebase init failed:", e);
  var db = null;
}

/* ==============
   Application logic
   ============== */

const DEFAULT_MARKET = {
  lastUpdate: Date.now(),
  stocks: {
    "WSTK": { name: "WESTOCKS Inc.", price: 12.00 },
    "RNDM": { name: "RandomTech", price: 45.50 },
    "BLUE": { name: "BlueChipCo", price: 128.75 },
    "FLUX": { name: "Flux Dynamics", price: 6.30 }
  }
};

const MARKET_DOC = "market/global";
const PORTFOLIO_DOC = "portfolio/global"; // shared across users (demo)

let market = null;
let portfolio = { cashUSD: 0, holdings: {} };
let updatingMarketLocally = false;

/* helper */
function fmtUSD(x) {
  return (typeof x === "number" ? "$ " + x.toFixed(2) : x);
}

/* Render functions */
function renderMarketUI() {
  const container = document.getElementById("marketList");
  container.innerHTML = "";
  for (const [sym, info] of Object.entries(market.stocks)) {
    const dom = document.createElement("div");
    dom.className = "stock";
    dom.innerHTML = `
      <div class="meta">
        <div><strong>${sym}</strong></div>
        <div class="small">${info.name}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-weight:800;">${fmtUSD(info.price)}</div>
        <div style="margin-top:6px;">
          <button class="btn btn-ghost btn-buy" data-symbol="${sym}">Buy</button>
          <button class="btn btn-ghost btn-sell" data-symbol="${sym}">Sell</button>
        </div>
      </div>
    `;
    container.appendChild(dom);
  }

  // attach buttons
  container.querySelectorAll(".btn-buy").forEach(b => b.addEventListener("click", e => {
    const sym = e.currentTarget.dataset.symbol;
    attemptBuy(sym);
  }));
  container.querySelectorAll(".btn-sell").forEach(b => b.addEventListener("click", e => {
    const sym = e.currentTarget.dataset.symbol;
    attemptSell(sym);
  }));
}

function renderPortfolioUI() {
  const el = document.getElementById("portfolioList");
  el.innerHTML = "";
  const cashRow = document.createElement("div");
  cashRow.className = "row";
  cashRow.innerHTML = `<div>Cash (USD)</div><div style="font-weight:800;">${fmtUSD(portfolio.cashUSD)}</div>`;
  el.appendChild(cashRow);

  const holdings = portfolio.holdings || {};
  if (Object.keys(holdings).length === 0) {
    const empty = document.createElement("div");
    empty.className = "small";
    empty.textContent = "No holdings yet.";
    el.appendChild(empty);
  } else {
    for (const [sym, qty] of Object.entries(holdings)) {
      const row = document.createElement("div");
      row.className = "row";
      const price = market && market.stocks[sym] ? market.stocks[sym].price : 0;
      row.innerHTML = `<div style="max-width:220px;"><strong>${sym}</strong> × ${qty.toFixed(4)} <div class="small">${market.stocks && market.stocks[sym] ? market.stocks[sym].name : ''}</div></div>
                       <div style="text-align:right;">
                         <div>${fmtUSD(qty * price)}</div>
                         <div style="margin-top:6px;"><button class="btn btn-ghost btn-sell-one" data-symbol="${sym}">Sell all</button></div>
                       </div>`;
      el.appendChild(row);
    }
    el.querySelectorAll(".btn-sell-one").forEach(b => b.addEventListener("click", e => {
      attemptSell(e.currentTarget.dataset.symbol, true);
    }));
  }
  document.getElementById("cashBal").innerText = fmtUSD(portfolio.cashUSD);
}

/* ==============
   Firestore helpers
   ============== */
function writeMarketToFirestore() {
  if (!db) return;
  updatingMarketLocally = true;
  db.doc(MARKET_DOC).set(market).catch(console.error).finally(() => { updatingMarketLocally = false; });
}

function writePortfolioToFirestore() {
  if (!db) return;
  db.doc(PORTFOLIO_DOC).set(portfolio).catch(console.error);
}

/* load or create market & portfolio */
async function initializeSharedState() {
  if (!db) {
    // no firestore: use defaults and localStorage fallback
    market = JSON.parse(localStorage.getItem("demo_market") || JSON.stringify(DEFAULT_MARKET));
    portfolio = JSON.parse(localStorage.getItem("demo_portfolio") || JSON.stringify(portfolio));
    renderMarketUI(); renderPortfolioUI();
    startLocalPriceFluctuation();
    return;
  }

  // Watch market doc
  db.doc(MARKET_DOC).onSnapshot(doc => {
    if (!doc.exists) {
      market = DEFAULT_MARKET;
      writeMarketToFirestore();
    } else {
      if (!updatingMarketLocally) {
        market = doc.data();
      } else {
        // our local write caused this snapshot; still update local variable
        market = doc.data();
      }
    }
    renderMarketUI();
    renderPortfolioUI();
  });

  // Watch portfolio doc (global)
  db.doc(PORTFOLIO_DOC).onSnapshot(doc => {
    if (!doc.exists) {
      // create default portfolio
      portfolio = { cashUSD: 0, holdings: {} };
      writePortfolioToFirestore();
    } else {
      portfolio = doc.data();
    }
    renderPortfolioUI();
  });
}

/* ==============
   Market price random walk
   ============== */
function randomWalkPrices() {
  if (!market) return;
  const now = Date.now();
  for (const [sym, info] of Object.entries(market.stocks)) {
    // random percent change between -3% and +3%
    const pct = (Math.random() - 0.5) * 0.06;
    let newPrice = Math.max(0.01, info.price * (1 + pct));
    market.stocks[sym].price = Number(newPrice.toFixed(2));
  }
  market.lastUpdate = now;
  writeMarketToFirestore();
}

/* fallback local random fluctuation if no Firestore */
function startLocalPriceFluctuation() {
  setInterval(() => {
    randomWalkPrices();
    localStorage.setItem("demo_market", JSON.stringify(market));
    renderMarketUI();
    renderPortfolioUI();
  }, 5000 + Math.random()*3000);
}

/* ==============
   Buy / Sell logic
   ============== */

function currencyToUSD(amount, currency) {
  // demo fixed rates only for UX. In real app use live FX.
  const rates = { USD:1, EUR:1.08, GBP:1.25 }; // 1 EUR = 1.08 USD etc (example)
  return amount * (rates[currency] || 1);
}

function attemptBuy(symbol) {
  const amt = parseFloat(document.getElementById("amountInput").value);
  const currency = document.getElementById("currencySelect").value;
  if (isNaN(amt) || amt <= 0) {
    alert("Enter a positive amount to invest.");
    return;
  }
  const usd = currencyToUSD(amt, currency);
  const price = market.stocks[symbol].price;
  const shares = usd / price;
  // allow negatives cash
  portfolio.cashUSD -= usd;
  portfolio.holdings[symbol] = (portfolio.holdings[symbol] || 0) + shares;
  writePortfolioToFirestore();
  renderPortfolioUI();
  // nice feedback
  toast(`Bought ${shares.toFixed(4)} ${symbol} for ${fmtUSD(usd)} (converted from ${currency}).`);
}

function attemptSell(symbol, sellAll = false) {
  const holding = portfolio.holdings[symbol] || 0;
  if (holding <= 0) {
    alert("No holdings to sell.");
    return;
  }
  const price = market.stocks[symbol].price;
  const amountUSD = holding * price;
  // Sell all (simple)
  portfolio.cashUSD += amountUSD;
  delete portfolio.holdings[symbol];
  writePortfolioToFirestore();
  renderPortfolioUI();
  toast(`Sold ${symbol} for ${fmtUSD(amountUSD)}.`);
}

/* small toast */
function toast(msg) {
  const t = document.createElement("div");
  t.textContent = msg;
  t.style.position = "fixed";
  t.style.right = "20px";
  t.style.bottom = "20px";
  t.style.padding = "12px 16px";
  t.style.background = "rgba(0,0,0,0.7)";
  t.style.color = "white";
  t.style.borderRadius = "8px";
  t.style.zIndex = 9999;
  document.body.appendChild(t);
  setTimeout(()=> t.style.opacity = "0.0", 2500);
  setTimeout(()=> t.remove(), 3200);
}

/* ==============
   UI wiring
   ============== */
document.getElementById("askBtn").addEventListener("click", () => {
  const askBtn = document.getElementById("askBtn");
  askBtn.innerText = "How much do you want to invest?";
  document.getElementById("askArea").style.display = "flex";
  document.getElementById("amountInput").focus();
});

document.getElementById("buyBtn").addEventListener("click", () => {
  // if user selected a symbol? We'll default to first market symbol for "Buy" quick action
  const firstSym = Object.keys(market.stocks)[0];
  if (!firstSym) { alert("No market data."); return; }
  attemptBuy(firstSym);
});

document.getElementById("helpBtn").addEventListener("click", () => {
  document.getElementById("helpBox").style.display = "block";
});
document.getElementById("closeHelp").addEventListener("click", () => {
  document.getElementById("helpBox").style.display = "none";
});

/* keyboard: press Enter in amount to click Buy */
document.getElementById("amountInput").addEventListener("keydown", e => {
  if (e.key === "Enter") document.getElementById("buyBtn").click();
});

/* ==============
   Periodic market updates (clients will write to shared doc)
   ============== */
setInterval(() => {
  // occasionally update market prices from this client
  if (!market) return;
  // small probability to run update to avoid thundering herd
  if (Math.random() < 0.4) {
    randomWalkPrices();
  }
}, 5000);

/* If Firestore is not available, fallback to local behavior */
initializeSharedState();

/* ==============
   Starfield background (canvas)
   ============== */
(function starfield(){
  const canvas = document.getElementById("stars");
  const ctx = canvas.getContext("2d");
  let W = canvas.width = innerWidth;
  let H = canvas.height = innerHeight;
  const num = Math.floor((W*H)/6000); // density
  const stars = [];
  for (let i=0;i<num;i++) stars.push({
    x: Math.random()*W,
    y: Math.random()*H,
    r: Math.random()*1.4 + 0.3,
    vx: (Math.random()-0.5)*0.05,
    vy: (Math.random()-0.5)*0.05,
    alpha: Math.random()*0.7 + 

