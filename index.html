<script>
document.addEventListener("DOMContentLoaded",()=>{

/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDcgWQyY9QewcZ5v1QLC6rRD9AWfqicKgQ",
  authDomain: "westocks-5184b.firebaseapp.com",
  databaseURL: "https://westocks-5184b-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "westocks-5184b",
  storageBucket: "westocks-5184b.firebasestorage.app",
  messagingSenderId: "265102905724",
  appId: "1:265102905724:web:52c5c7365df3929a32d4f9"
});
const db = firebase.database();

/* ELEMENTS */
const startBtn=document.getElementById("startBtn");
const start=document.getElementById("start");
const market=document.getElementById("market");
const cashEl=document.getElementById("cash");
const portfolioEl=document.getElementById("portfolio");
const stocksEl=document.getElementById("stocks");
const leaderboardEl=document.getElementById("leaderboard");
const activeEl=document.getElementById("active");

/* USER INFO */
const username = prompt("Enter username") || "Guest" + Math.floor(Math.random()*1000);
const sessionId = Math.random().toString(36).slice(2);

/* FIREBASE REFS */
const activeRef = db.ref("activePlayers");
const leaderboardRef = db.ref("leaderboard");

/* ADD ACTIVE PLAYER */
activeRef.child(sessionId).set({name: username});
activeRef.child(sessionId).onDisconnect().remove();

/* LISTEN ACTIVE PLAYER COUNT */
activeRef.on("value",snap=>{
  activeEl.innerText = "Active Players: "+snap.numChildren();
});

/* STOCK DATA */
let cash=1000;
const stocks={
  NOVA:{price:120,shares:0,history:[120],buyPrice:null,show:false},
  ORBX:{price:80,shares:0,history:[80],buyPrice:null,show:false},
  ZENT:{price:200,shares:0,history:[200],buyPrice:null,show:false}
};

/* START BUTTON */
startBtn.onclick=()=>{
  start.style.display="none";
  market.style.display="block";
  render();
};

/* UPDATE STOCK PRICES */
setInterval(()=>{
  for(const s in stocks){
    let st=stocks[s];
    let change=(Math.random()-0.5)*0.05;
    st.price=Math.max(1,+(st.price*(1+change)).toFixed(2));
    st.history.push(st.price);
    if(st.history.length>60) st.history.shift();
  }
  render();
},2500);

/* BUY / SELL */
window.buy=function(sym){
  let amt=parseFloat(document.getElementById("buy-"+sym).value);
  if(!amt||amt>cash) return;
  let st=stocks[sym];
  let shares=amt/st.price;
  cash-=amt;
  st.shares+=shares;
  st.buyPrice=st.price;
  render();
};
window.buyAll=function(sym){
  let st=stocks[sym];
  st.shares+=cash/st.price;
  st.buyPrice=st.price;
  cash=0;
  render();
};
window.sell=function(sym){
  let qty=parseFloat(document.getElementById("sell-"+sym).value);
  let st=stocks[sym];
  if(!qty||qty>st.shares) return;
  st.shares-=qty;
  cash+=qty*st.price;
  render();
};
window.sellAll=function(sym){
  let st=stocks[sym];
  cash+=st.shares*st.price;
  st.shares=0;
  render();
};

/* GRAPH TOGGLE */
window.toggleGraph=function(sym){
  stocks[sym].show=!stocks[sym].show;
  render();
};

/* GRAPH DRAW */
function drawGraph(sym){
  let c=document.getElementById("g-"+sym);
  let ctx=c.getContext("2d");
  let data=stocks[sym].history;
  ctx.clearRect(0,0,c.width,c.height);
  let min=Math.min(...data);
  let max=Math.max(...data);

  ctx.lineWidth=2;
  ctx.shadowBlur=8;
  ctx.shadowColor="cyan";
  ctx.strokeStyle="cyan";
  ctx.beginPath();
  data.forEach((p,i)=>{
    let x=i/(data.length-1)*c.width;
    let y=c.height-(p-min)/(max-min+0.01)*c.height;
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  });
  ctx.stroke();

  if(stocks[sym].buyPrice){
    let y=c.height-(stocks[sym].buyPrice-min)/(max-min+0.01)*c.height;
    ctx.shadowBlur=12;
    ctx.strokeStyle="lime";
    ctx.beginPath();
    ctx.moveTo(0,y);
    ctx.lineTo(c.width,y);
    ctx.stroke();
  }
}

/* RENDER */
function render(){
  cashEl.innerText=cash.toFixed(2);
  let total=cash;
  for(const s in stocks) total+=stocks[s].shares*stocks[s].price;
  portfolioEl.innerText=total.toFixed(2);

  // update leaderboard value
  leaderboardRef.child(sessionId).set({
    name: username,
    value: total
  });

  stocksEl.innerHTML=Object.keys(stocks).map(s=>{
    let st=stocks[s];
    let pl=(st.shares*(st.price-(st.buyPrice||st.price))).toFixed(2);
    return `
    <div class="stock">
      <strong>${s}</strong> — $${st.price}<br>
      Shares: ${st.shares.toFixed(3)} <span class="pl">PL: $${pl}</span><br><br>

      Buy $ <input id="buy-${s}" type="number">
      <button class="buy" onclick="buy('${s}')">Buy</button>
      <button class="buy" onclick="buyAll('${s}')">Buy All</button>

      Sell <input id="sell-${s}" type="number" step="0.01">
      <button class="sell" onclick="sell('${s}')">Sell</button>
      <button class="sell" onclick="sellAll('${s}')">Sell All</button>

      <button class="toggle" onclick="toggleGraph('${s}')">Graph</button>

      <canvas id="g-${s}" width="800" height="140" style="display:${st.show?'block':'none'}"></canvas>
    </div>`;
  }).join("");

  for(const s in stocks) if(stocks[s].show) drawGraph(s);
}

/* ✅ LEADERBOARD — RICHEST FIRST */
leaderboardRef.on("value", snap=>{
  let arr=[];
  snap.forEach(c=>arr.push(c.val()));

  arr.sort((a,b)=>b.value-a.value); // richest → poorest

  leaderboardEl.innerHTML = arr
    .slice(0,10)
    .map((p,i)=>`<li>#${i+1} ${p.name}: $${p.value.toFixed(2)}</li>`)
    .join("");
});

});
</script>
