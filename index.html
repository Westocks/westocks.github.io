<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Neon Tower Shooter â€“ Full Gems & Upgrades Working</title>
<style>
html, body { margin:0; padding:0; overflow:hidden; background:#000; }
canvas { display:block; }
#ui { position:fixed; top:10px; left:10px; color:#0ff; font-family:Arial; z-index:5; pointer-events:none; }
#bottomUI { position:fixed; bottom:10px; left:50%; transform:translateX(-50%); display:flex; gap:10px; z-index:5; }
#bottomUI button { padding:12px 18px; background:#111; color:#0ff; border:1px solid #0ff; cursor:pointer; }
#overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); color:#0ff; font-family:Arial; display:flex; align-items:center; justify-content:center; z-index:10; }
.panel { border:2px solid #0ff; padding:20px; min-width:300px; text-align:center; }
.panel button { margin:8px; padding:10px; background:#111; color:#0ff; border:1px solid #0ff; cursor:pointer; }
</style>
</head>
<body>
<div id="ui">
  <div id="coins"></div>
  <div id="hp"></div>
  <div id="shield"></div>
  <div id="gems"></div>
</div>
<div id="bottomUI">
  <button id="dmgBtn">Damage +1 (5ðŸª™)</button>
  <button id="rateBtn">Fire Rate (5ðŸª™)</button>
  <button id="autoBtn">Auto Fire (15ðŸª™)</button>
  <button id="speedBtn">Move Speed (8ðŸª™)</button>
  <button id="pierceBtn">Pierce +1 (10ðŸª™)</button>
  <button id="healBtn">Heal +1 HP (6ðŸª™)</button>
  <button id="leftDroneBtn">Left Drone (20ðŸª™)</button>
  <button id="rightDroneBtn">Right Drone (20ðŸª™)</button>
</div>
<canvas id="game"></canvas>
<div id="overlay">
  <div class="panel">
    <h2>NEON TOWER</h2>
    <p>Gems: <span id="metaGems"></span></p>
    <button id="metaHp">+ Max HP (10ðŸ’Ž)</button>
    <button id="metaShield">+ Max Shield (10ðŸ’Ž)</button>
    <button id="metaDamage">+ Start Damage (15ðŸ’Ž)</button>
    <button id="metaSpeed">+ Start Speed (15ðŸ’Ž)</button>
    <button id="metaPierce">+ Start Pierce (20ðŸ’Ž)</button>
    <button id="metaRegen">+ HP Regen (25ðŸ’Ž)</button>
    <button id="metaMagnet">+ Coin Magnet (30ðŸ’Ž)</button>
    <button id="petGamble">ðŸŽ° Gamble Pet (25ðŸ’Ž)</button>
    <p id="petText"></p>
    <hr>
    <button id="startBtn">START RUN</button>
  </div>
</div>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}resize();addEventListener('resize',resize);

let gems = Number(localStorage.getItem('gems')||0);
let meta = { hp:0, shield:0, damage:0, speed:0, pierce:0, regen:0, magnet:0, pet:localStorage.getItem('pet')||null };
let mouseX=0, mouseY=0;
const keys={};
canvas.addEventListener('mousemove',e=>{const r=canvas.getBoundingClientRect();mouseX=e.clientX-r.left;mouseY=e.clientY-r.top;});
addEventListener('keydown',e=>keys[e.code]=true);
addEventListener('keyup',e=>keys[e.code]=false);

let bullets=[], enemies=[], particles=[];
let coins=0, shootCooldown=false, gameOver=true, shake=0;
let px=0, py=0, runTime=0;
let player=null;

function createSparks(x,y,color,count,speed=4){for(let i=0;i<count;i++){particles.push({x,y,vx:(Math.random()-0.5)*speed,vy:(Math.random()-0.5)*speed,life:Math.floor(Math.random()*20+10),color});}}

function startGame(){
  bullets=[]; enemies=[]; particles=[];
  coins=0; runTime=0; shake=0;
  px=canvas.width/2; py=canvas.height/2;
  player={ angle:0, speed:4+meta.speed, fireDelay:450, damage:1+meta.damage, pierce:1+meta.pierce, maxHp:5+meta.hp, hp:5+meta.hp, maxShield:3+meta.shield, shield:3+meta.shield, auto:false, leftDrone:false, rightDrone:false };
  if(meta.pet==='damage') player.damage*=1.1;
  if(meta.pet==='speed') player.speed*=1.1;
  if(meta.pet==='shield') player.maxShield+=1;
  gameOver=false;
  document.getElementById('overlay').style.display='none';
}

function refreshMeta(){ document.getElementById('metaGems').textContent=gems; }
function saveMeta(){ localStorage.setItem('gems',gems); refreshMeta(); }
refreshMeta();

document.getElementById('startBtn').addEventListener('click',()=>{ startGame(); if(!window.gameLoopInitialized){ window.gameLoopInitialized=true; loop(); } });

const upgradeCosts = { dmg:5, rate:5, auto:15, speed:8, pierce:10, heal:6, leftDrone:20, rightDrone:20 };
document.getElementById('dmgBtn').onclick=()=>{if(coins>=upgradeCosts.dmg){coins-=upgradeCosts.dmg;player.damage++;}}
document.getElementById('rateBtn').onclick=()=>{if(coins>=upgradeCosts.rate){coins-=upgradeCosts.rate;player.fireDelay=Math.max(50,player.fireDelay-50);}}
document.getElementById('autoBtn').onclick=()=>{if(coins>=upgradeCosts.auto){coins-=upgradeCosts.auto;player.auto=true;}}
document.getElementById('speedBtn').onclick=()=>{if(coins>=upgradeCosts.speed){coins-=upgradeCosts.speed;player.speed+=1;}}
document.getElementById('pierceBtn').onclick=()=>{if(coins>=upgradeCosts.pierce){coins-=upgradeCosts.pierce;player.pierce+=1;}}
document.getElementById('healBtn').onclick=()=>{if(coins>=upgradeCosts.heal){coins-=upgradeCosts.heal;player.hp=Math.min(player.hp+1,player.maxHp);}}
document.getElementById('leftDroneBtn').onclick=()=>{if(coins>=upgradeCosts.leftDrone){coins-=upgradeCosts.leftDrone;player.leftDrone=true;}}
document.getElementById('rightDroneBtn').onclick=()=>{if(coins>=upgradeCosts.rightDrone){coins-=upgradeCosts.rightDrone;player.rightDrone=true;}}

// --- META-UPGRADE BUTTONS ---
document.getElementById('metaHp').onclick = () => { if(gems>=10){ gems-=10; meta.hp++; saveMeta(); } };
document.getElementById('metaShield').onclick = () => { if(gems>=10){ gems-=10; meta.shield++; saveMeta(); } };
document.getElementById('metaDamage').onclick = () => { if(gems>=15){ gems-=15; meta.damage++; saveMeta(); } };
document.getElementById('metaSpeed').onclick = () => { if(gems>=15){ gems-=15; meta.speed++; saveMeta(); } };
document.getElementById('metaPierce').onclick = () => { if(gems>=20){ gems-=20; meta.pierce++; saveMeta(); } };
document.getElementById('metaRegen').onclick = () => { if(gems>=25){ gems-=25; meta.regen++; saveMeta(); } };
document.getElementById('metaMagnet').onclick = () => { if(gems>=30){ gems-=30; meta.magnet++; saveMeta(); } };
document.getElementById('petGamble').onclick = () => {
  if(gems>=25){
    gems-=25;
    const pets=['damage','speed','shield','none'];
    meta.pet = pets[Math.floor(Math.random()*pets.length)];
    localStorage.setItem('pet', meta.pet);
    document.getElementById('petText').textContent = meta.pet==='none'?'No pet this time.':`You got ${meta.pet} pet!`;
    saveMeta();
  }
};

function shoot(ox=px, oy=py, dmg=player.damage, pierce=player.pierce){ bullets.push({x:ox,y:oy,angle:player.angle,speed:10,damage:dmg,pierce:pierce}); createSparks(ox,oy,'#0ff',6,5); }

function spawnEnemy(){ if(gameOver) return; const s=Math.floor(Math.random()*4); let x,y; if(s===0){x=0;y=Math.random()*canvas.height;} if(s===1){x=canvas.width;y=Math.random()*canvas.height;} if(s===2){x=Math.random()*canvas.width;y=0;} if(s===3){x=Math.random()*canvas.width;y=canvas.height;} const t=Math.random(); enemies.push(t<0.6?{x,y,hp:4,size:14,speed:1.6,type:'normal'}:t<0.85?{x,y,hp:9,size:20,speed:1,type:'tank'}:{x,y,hp:2,size:10,speed:3,type:'fast'}); }
setInterval(spawnEnemy,900);

function update(){
  if(gameOver || !player) return;
  runTime++;
  if(keys.KeyW) py-=player.speed; if(keys.KeyS) py+=player.speed;
  if(keys.KeyA) px-=player.speed; if(keys.KeyD) px+=player.speed;
  px=Math.max(0, Math.min(canvas.width, px)); py=Math.max(0, Math.min(canvas.height, py));
  player.angle=Math.atan2(mouseY-py, mouseX-px);

  if(player.auto && !shootCooldown){ shoot(px,py,player.damage,player.pierce); shootCooldown=true; setTimeout(()=>shootCooldown=false,player.fireDelay); }
  if(keys.Space && !shootCooldown){ shoot(px,py,player.damage,player.pierce); shootCooldown=true; setTimeout(()=>shootCooldown=false,player.fireDelay); }

  if(player.leftDrone && runTime%15===0) shoot(px+Math.cos(player.angle-Math.PI/2)*22, py+Math.sin(player.angle-Math.PI/2)*22, Math.max(1,player.damage*0.5), 1);
  if(player.rightDrone && runTime%35===0) shoot(px+Math.cos(player.angle+Math.PI/2)*22, py+Math.sin(player.angle+Math.PI/2)*22, player.damage*2, 2);

  for(let i=bullets.length-1;i>=0;i--){ let b=bullets[i]; b.x+=Math.cos(b.angle)*b.speed; b.y+=Math.sin(b.angle)*b.speed; if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height) bullets.splice(i,1); }

  for(let i=enemies.length-1;i>=0;i--){
    let e=enemies[i]; let dx=px-e.x, dy=py-e.y, d=Math.hypot(dx,dy); e.x+=dx/d*e.speed; e.y+=dy/d*e.speed;
    if(d<e.size+14){ createSparks(px,py,'#f00',20,6); player.shield>0?player.shield--:player.hp--; enemies.splice(i,1); if(player.hp<=0){ gameOver=true; createSparks(px,py,'#f0f',50,8); gems+=Math.floor(runTime/600); saveMeta(); document.getElementById('overlay').style.display='flex'; } }
    for(let j=bullets.length-1;j>=0;j--){ let b=bullets[j]; if(Math.hypot(e.x-b.x,e.y-b.y)<e.size){ e.hp-=b.damage; b.pierce--; createSparks(e.x,e.y,'#0ff',6,5); if(b.pierce<=0) bullets.splice(j,1); if(e.hp<=0){ coins++; gems++; saveMeta(); enemies.splice(i,1); createSparks(e.x,e.y,'#ff0',20,6); } } }
  }

  document.getElementById('coins').textContent=`Coins: ${coins}`;
  document.getElementById('hp').textContent=`HP: ${player.hp}/${player.maxHp}`;
  document.getElementById('shield').textContent=`Shield: ${player.shield}/${player.maxShield}`;
  document.getElementById('gems').textContent=`Gems: ${gems}`;
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(player){ ctx.save(); ctx.translate(px,py); ctx.rotate(player.angle); ctx.fillStyle='#0ff'; ctx.shadowBlur=15; ctx.shadowColor='#0ff'; ctx.beginPath(); ctx.moveTo(20,0); ctx.lineTo(-12,-12); ctx.lineTo(-6,0); ctx.lineTo(-12,12); ctx.closePath(); ctx.fill(); ctx.shadowBlur=0; ctx.restore(); }
  bullets.forEach(b=>{ ctx.fillStyle='#ff0'; ctx.shadowBlur=10; ctx.shadowColor='#ff0'; ctx.fillRect(b.x-2,b.y-2,4,4); ctx.shadowBlur=0; });
  enemies.forEach(e=>{ ctx.beginPath(); ctx.arc(e.x,e.y,e.size,0,Math.PI*2); ctx.strokeStyle=e.type==='tank'?'#0f0':e.type==='fast'?'#f00':'#f0f'; ctx.lineWidth=3; ctx.shadowBlur=15; ctx.shadowColor=ctx.strokeStyle; ctx.stroke(); ctx.shadowBlur=0; });
  particles.forEach(p=>{ ctx.fillStyle=p.color; ctx.fillRect(p.x-2,p.y-2,4,4); p.x+=p.vx; p.y+=p.vy; p.life--; });
  particles=particles.filter(p=>p.life>0);
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }
</script>
</body>
