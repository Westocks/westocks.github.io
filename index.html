<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WESTOCKS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
html,body{
  margin:0;height:100%;
  font-family:Arial,sans-serif;
  color:white;
}
body{
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(270deg,#0f2027,#203a43,#2c5364);
  background-size:600% 600%;
  animation:bg 18s ease infinite;
}
@keyframes bg{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
.container{
  max-width:1000px;width:100%;
  background:rgba(0,0,0,.45);
  padding:20px;border-radius:16px;
}
h1{text-align:center;letter-spacing:4px}
button{
  padding:6px 12px;border:none;
  border-radius:6px;font-weight:bold;
  cursor:pointer;
}
.buy{background:white;color:black}
.sell{background:#ffb3b3;color:black}
.toggle{background:rgba(255,255,255,.2);color:white}
.stock{
  margin-top:16px;padding:14px;
  background:rgba(255,255,255,.08);
  border-radius:12px;
}
canvas{
  width:100%;height:140px;
  margin-top:8px;
  background:rgba(0,0,0,.3);
  border-radius:8px;
  display:none;
}
input{width:80px;padding:4px;border-radius:4px;border:none}
#active{text-align:center;margin-bottom:8px}
.pl{color:cyan;font-weight:bold}
#leaderboardBox{display:none}
</style>
</head>

<body>
<div class="container">
<h1>WESTOCKS</h1>
<div id="active">Active Players: 0</div>

<div id="start">
  <p style="text-align:center">Demo only ‚Äî not real money</p>
  <div style="text-align:center">
    <button class="buy" id="startBtn">Start Investing</button>
  </div>
</div>

<div id="market" style="display:none">
  Cash: $<span id="cash">1000.00</span><br>
  Portfolio: $<span id="portfolio">1000.00</span><br><br>

  <button class="toggle" onclick="toggleLeaderboard()">Toggle Leaderboard</button>

  <div class="stock" id="leaderboardBox">
    <strong>üèÜ Leaderboard</strong>
    <ol id="leaderboard"></ol>
  </div>

  <div id="stocks"></div>
</div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

/* üî• FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDcgWQyY9QewcZ5v1QLC6rRD9AWfqicKgQ",
  authDomain: "westocks-5184b.firebaseapp.com",
  databaseURL: "https://westocks-5184b-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "westocks-5184b",
  storageBucket: "westocks-5184b.firebasestorage.app",
  messagingSenderId: "265102905724",
  appId: "1:265102905724:web:52c5c7365df3929a32d4f9"
});
const db = firebase.database();

/* USER */
const username = prompt("Username") || "Guest"+Math.floor(Math.random()*1000);
const sessionId = Math.random().toString(36).slice(2);

/* REFS */
const activeRef = db.ref("activePlayers");
const leaderboardRef = db.ref("leaderboard");

/* ACTIVE PLAYERS */
activeRef.child(sessionId).set({name:username});
activeRef.child(sessionId).onDisconnect().remove();
activeRef.on("value",s=>{
  document.getElementById("active").innerText =
    "Active Players: "+s.numChildren();
});

/* LEADERBOARD */
leaderboardRef.on("value",snap=>{
  let arr=[];
  snap.forEach(c=>arr.push(c.val()));
  arr.sort((a,b)=>b.value-a.value);
  document.getElementById("leaderboard").innerHTML =
    arr.slice(0,10)
      .map(p=>`<li>${p.name}: $${p.value.toFixed(2)}</li>`)
      .join("");
});

/* ELEMENTS */
const startBtn = document.getElementById("startBtn");
const start = document.getElementById("start");
const market = document.getElementById("market");
const cashEl = document.getElementById("cash");
const portfolioEl = document.getElementById("portfolio");
const stocksEl = document.getElementById("stocks");
const leaderboardBox = document.getElementById("leaderboardBox");

/* GAME DATA */
let cash=1000;
const stocks={
  NOVA:{price:120,shares:0,history:[120],buyPrice:null,show:false},
  ORBX:{price:80,shares:0,history:[80],buyPrice:null,show:false},
  ZENT:{price:200,shares:0,history:[200],buyPrice:null,show:false}
};

/* START BUTTON (FIXED) */
startBtn.onclick=()=>{
  start.style.display="none";
  market.style.display="block";
  render();
};

/* PRICE UPDATE */
setInterval(()=>{
  for(const s in stocks){
    let st=stocks[s];
    let ch=(Math.random()-0.5)*0.05;
    st.price=Math.max(1,+(st.price*(1+ch)).toFixed(2));
    st.history.push(st.price);
    if(st.history.length>60)st.history.shift();
  }
  render();
},2500);

/* BUY / SELL */
window.buy=s=>{
  let a=+document.getElementById("buy-"+s).value;
  if(!a||a>cash)return;
  let st=stocks[s];
  cash-=a;
  st.shares+=a/st.price;
  st.buyPrice=st.price;
  render();
};
window.buyAll=s=>{
  let st=stocks[s];
  st.shares+=cash/st.price;
  st.buyPrice=st.price;
  cash=0;render();
};
window.sell=s=>{
  let q=+document.getElementById("sell-"+s).value;
  let st=stocks[s];
  if(!q||q>st.shares)return;
  st.shares-=q;
  cash+=q*st.price;
  render();
};
window.sellAll=s=>{
  let st=stocks[s];
  cash+=st.shares*st.price;
  st.shares=0;render();
};

/* TOGGLES */
window.toggleGraph=s=>{
  stocks[s].show=!stocks[s].show;
  render();
};
window.toggleLeaderboard=()=>{
  leaderboardBox.style.display =
    leaderboardBox.style.display==="none"?"block":"none";
};

/* DRAW GRAPH */
function drawGraph(s){
  let c=document.getElementById("g-"+s);
  let ctx=c.getContext("2d");
  let d=stocks[s].history;
  let min=Math.min(...d),max=Math.max(...d);
  ctx.clearRect(0,0,c.width,c.height);
  ctx.shadowBlur=8;ctx.strokeStyle="cyan";
  ctx.beginPath();
  d.forEach((p,i)=>{
    let x=i/(d.length-1)*c.width;
    let y=c.height-(p-min)/(max-min+0.01)*c.height;
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  });
  ctx.stroke();
  if(stocks[s].buyPrice){
    let y=c.height-(stocks[s].buyPrice-min)/(max-min+0.01)*c.height;
    ctx.strokeStyle="lime";
    ctx.beginPath();
    ctx.moveTo(0,y);
    ctx.lineTo(c.width,y);
    ctx.stroke();
  }
}

/* RENDER */
function render(){
  cashEl.innerText=cash.toFixed(2);
  let total=cash;
  for(const s in stocks) total+=stocks[s].shares*stocks[s].price;
  portfolioEl.innerText=total.toFixed(2);

  leaderboardRef.child(sessionId)
    .set({name:username,value:total});

  stocksEl.innerHTML=Object.keys(stocks).map(s=>{
    let st=stocks[s];
    let pl=st.shares*(st.price-(st.buyPrice||st.price));
    return `
    <div class="stock">
      <strong>${s}</strong> ‚Äî $${st.price}<br>
      Shares: ${st.shares.toFixed(3)}
      <span class="pl">PL: $${pl.toFixed(2)}</span><br><br>

      Buy $ <input id="buy-${s}">
      <button class="buy" onclick="buy('${s}')">Buy</button>
      <button class="buy" onclick="buyAll('${s}')">Buy All</button><br><br>

      Sell <input id="sell-${s}">
      <button class="sell" onclick="sell('${s}')">Sell</button>
      <button class="sell" onclick="sellAll('${s}')">Sell All</button><br><br>

      <button class="toggle" onclick="toggleGraph('${s}')">Graph</button>
      <canvas id="g-${s}" width="800" height="140"
        style="display:${st.show?'block':'none'}"></canvas>
    </div>`;
  }).join("");

  for(const s in stocks) if(stocks[s].show) drawGraph(s);
}

});
</script>
</body>
</html>
