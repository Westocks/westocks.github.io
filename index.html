<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WESTOCKS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
html,body{margin:0;height:100%;font-family:Arial,sans-serif;color:white;}
body{display:flex;justify-content:center;align-items:center;background:linear-gradient(270deg,#0f2027,#203a43,#2c5364);background-size:600% 600%;animation:bg 18s ease infinite;}
@keyframes bg{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.container{max-width:1000px;width:100%;background:rgba(0,0,0,.45);padding:20px;border-radius:16px;}
h1{text-align:center;letter-spacing:4px;}
button{padding:6px 12px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;}
.buy{background:white;color:black;}
.sell{background:#ffb3b3;color:black;}
.toggle{background:rgba(255,255,255,.2);color:white;}
.stock{margin-top:16px;padding:14px;background:rgba(255,255,255,.08);border-radius:12px;}
canvas{width:100%;height:140px;margin-top:8px;background:rgba(0,0,0,.3);border-radius:8px;display:none;}
input{width:80px;padding:4px;border-radius:4px;border:none;}
#active{text-align:center;margin-bottom:6px;}
.pl{color:cyan;font-weight:bold;}
</style>
</head>

<body>
<div class="container">
<h1>WESTOCKS</h1>
<div id="active">Active Players: 0</div>

<div id="start">
  <p style="text-align:center">Demo only ‚Äî not real money</p>
  <div style="text-align:center">
    <button class="buy" id="startBtn">Start Investing</button>
  </div>
</div>

<div id="market" style="display:none">
  Cash: $<span id="cash">1000.00</span><br>
  Portfolio: $<span id="portfolio">1000.00</span>

  <div class="stock">
    <strong>üèÜ Leaderboard</strong>
    <ol id="leaderboard"></ol>
  </div>

  <div id="stocks"></div>
</div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDcgWQyY9QewcZ5v1QLC6rRD9AWfqicKgQ",
  authDomain: "westocks-5184b.firebaseapp.com",
  databaseURL: "https://westocks-5184b-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "westocks-5184b",
  storageBucket: "westocks-5184b.firebasestorage.app",
  messagingSenderId: "265102905724",
  appId: "1:265102905724:web:52c5c7365df3929a32d4f9"
});
const db = firebase.database();

/* ELEMENTS */
const startBtn=document.getElementById("startBtn");
const start=document.getElementById("start");
const market=document.getElementById("market");
const cashEl=document.getElementById("cash");
const portfolioEl=document.getElementById("portfolio");
const stocksEl=document.getElementById("stocks");
const leaderboardEl=document.getElementById("leaderboard");
const activeEl=document.getElementById("active");

/* USER INFO */
const username = prompt("Enter username") || "Guest"; // user enters nickname
const sessionId = Math.random().toString(36).slice(2);

/* FIREBASE REFS */
const activeRef = db.ref("activePlayers");
const leaderboardRef = db.ref("leaderboard");
const usersRef = db.ref("users"); // Reference to store user data

/* ADD ACTIVE PLAYER */
activeRef.child(sessionId).set({name: username});
activeRef.child(sessionId).onDisconnect().remove();

/* LOAD SAVED USER DATA */
let cash = 1000;
const stocks = {
  NOVA: {price: 120, shares: 0, history: [120], buyPrice: null, show: false},
  ORBX: {price: 80, shares: 0, history: [80], buyPrice: null, show: false},
  ZENT: {price: 200, shares: 0, history: [200], buyPrice: null, show: false}
};

usersRef.child(username).once("value", snap => {
  if (snap.exists()) {
    const data = snap.val();
    cash = data.cash ?? cash;

    if (data.stocks) {
      for (const s in stocks) {
        if (data.stocks[s]) {
          stocks[s] = { ...stocks[s], ...data.stocks[s] };
        }
      }
    }
    render();  // Render after loading saved data
  }
});

/* LISTEN ACTIVE PLAYER COUNT */
activeRef.on("value", snap => {
  activeEl.innerText = "Active Players: " + snap.numChildren();
});

/* START BUTTON */
startBtn.onclick = () => {
  start.style.display = "none";
  market.style.display = "block";
  render();
};

/* UPDATE STOCK PRICES */
setInterval(() => {
  for (const s in stocks) {
    let st = stocks[s];
    let change = (Math.random() - 0.5) * 0.05;
    st.price = Math.max(1, +(st.price * (1 + change)).toFixed(2));
    st.history.push(st.price);
    if (st.history.length > 60) st.history.shift();
  }
  render();
}, 2500);

/* BUY / SELL FUNCTIONS */
window.buy = function (sym) {
  let amt = parseFloat(document.getElementById("buy-" + sym).value);
  if (!amt || amt > cash) return;
  let st = stocks[sym];
  let shares = amt / st.price;
  cash -= amt;
  st.shares += shares;
  st.buyPrice = st.price;
  render();
};

window.buyAll = function (sym) {
  let st = stocks[sym];
  let shares = cash / st.price;
  st.shares += shares;
  st.buyPrice = st.price;
  cash = 0;
  render();
};

window.sell = function (sym) {
  let qty = parseFloat(document.getElementById("sell-" + sym).value);
  let st = stocks[sym];
  if (!qty || qty > st.shares) return;
  st.shares -= qty;
  cash += qty * st.price;
  render();
};

window.sellAll = function (sym) {
  let st = stocks[sym];
  cash += st.shares * st.price;
  st.shares = 0;
  render();
};

/* TOGGLE GRAPH */
window.toggleGraph = function (sym) {
  stocks[sym].show = !stocks[sym].show;
  render();
};

/* DRAW NEON GRAPH */
function drawGraph(sym) {
  let c = document.getElementById("g-" + sym);
  let ctx = c.getContext("2d");
  let data = stocks[sym].history;
  ctx.clearRect(0, 0, c.width, c.height);
  let min = Math.min(...data);
  let max = Math.max(...data);

  ctx.lineWidth = 2;
  ctx.shadowBlur = 8;
  ctx.shadowColor = "cyan";
  ctx.strokeStyle = "cyan";
  ctx.beginPath();
  data.forEach((p, i) => {
    let x = i / (data.length - 1) * c.width;
    let y = c.height - (p - min) / (max - min + 0.01) * c.height;
    i ? ctx.lineTo(x, y) : ctx.moveTo(x, y);
  });
  ctx.stroke();

  if (stocks[sym].buyPrice) {
    let y = c.height - (stocks[sym].buyPrice - min) / (max - min + 0.01) * c.height;
    ctx.shadowBlur = 12;
    ctx.strokeStyle = "lime";
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(c.width, y);
    ctx.stroke();
  }
}

/* SAVE USER DATA */
function saveUserData(total) {
  usersRef.child(username).set({
    cash: cash,
    stocks: stocks,
    portfolio: total,
    lastUpdated: Date.now()
  });
}

/* RENDER FUNCTION */
function render() {
  cashEl.innerText = cash.toFixed(2
