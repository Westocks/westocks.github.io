<script>
/* ===== STAR BACKGROUND ===== */
const sc=document.getElementById("stars");
const sctx=sc.getContext("2d");
function resize(){sc.width=innerWidth;sc.height=innerHeight}
resize();addEventListener("resize",resize);

const stars=[...Array(180)].map(()=>({
  x:Math.random()*sc.width,
  y:Math.random()*sc.height,
  r:Math.random()*1.5+.3,
  v:Math.random()*.4+.1
}));

(function animStars(){
  sctx.clearRect(0,0,sc.width,sc.height);
  stars.forEach(s=>{
    s.y+=s.v;
    if(s.y>sc.height)s.y=0;
    sctx.globalAlpha=Math.random();
    sctx.beginPath();
    sctx.arc(s.x,s.y,s.r,0,Math.PI*2);
    sctx.fillStyle="white";
    sctx.fill();
  });
  requestAnimationFrame(animStars);
})();

/* ===== DATA ===== */
let cash=1000;
const stocks={
  NOVA:{name:"Nova Dynamics",price:120,shares:0,history:[]},
  ORBX:{name:"Orbex Labs",price:75,shares:0,history:[]},
  ZENT:{name:"Zenith Core",price:200,shares:0,history:[]}
};

/* ===== START ===== */
function startDemo(){
  document.getElementById("start").style.display="none";
  document.getElementById("market").style.display="block";
  render();
}

/* ===== PRICE MOVEMENT ===== */
function updatePrices(){
  for(const s in stocks){
    const st=stocks[s];
    const change=(Math.random()-.5)*0.08;
    st.price=Math.max(5,+(st.price*(1+change)).toFixed(2));
    st.history.push(st.price);
    if(st.history.length>80)st.history.shift();
  }
  render();
}
setInterval(updatePrices,3000);

/* ===== BUY / SELL ===== */
function buy(sym){
  const usd=parseFloat(prompt("How much USD do you want to buy?"));
  if(isNaN(usd)||usd<=0)return;
  const st=stocks[sym];
  const shares=usd/st.price;
  cash-=usd;
  st.shares+=shares;
  render();
}

function sell(sym){
  const st=stocks[sym];
  const qty=parseFloat(prompt("How many shares do you want to sell?"));
  if(isNaN(qty)||qty<=0)return;
  if(qty>st.shares)return alert("You don't have that many shares");
  st.shares-=qty;
  cash+=qty*st.price;
  render();
}

/* ===== GRAPH ===== */
function toggleGraph(sym){
  const c=document.getElementById("g-"+sym);
  c.style.display=c.style.display==="none"?"block":"none";
  if(c.style.display==="block") drawGraph(sym);
}

function drawGraph(sym){
  const c=document.getElementById("g-"+sym);
  const ctx=c.getContext("2d");
  const data=stocks[sym].history;
  ctx.clearRect(0,0,c.width,c.height);
  if(data.length<2)return;

  const min=Math.min(...data);
  const max=Math.max(...data);

  ctx.strokeStyle="white";
  ctx.beginPath();
  data.forEach((p,i)=>{
    const x=i/(data.length-1)*c.width;
    const y=c.height-(p-min)/(max-min+.01)*c.height;
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  });
  ctx.stroke();
}

/* ===== RENDER ===== */
function render(){
  document.getElementById("cash").innerText=cash.toFixed(2);
  const wrap=document.getElementById("stocks");
  wrap.innerHTML="";
  for(const s in stocks){
    const st=stocks[s];
    const div=document.createElement("div");
    div.className="stock";
    div.innerHTML=`
      <div class="stock-header">
        <div>
          <strong>${s}</strong>
          <div class="small">${st.name}</div>
          <div class="small">Owned: ${st.shares.toFixed(3)}</div>
        </div>
        <div style="text-align:right">
          <div class="stock-price">$${st.price}</div>
          <button class="trade" onclick="buy('${s}')">Buy</button>
          <button class="trade" onclick="sell('${s}')">Sell</button>
          <button class="toggle" onclick="toggleGraph('${s}')">Graph</button>
        </div>
      </div>
      <canvas class="graph" id="g-${s}" width="800" height="120"></canvas>
    `;
    wrap.appendChild(div);
  }
}
</script>
