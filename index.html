<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WESTOCKS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDcgWQyY9QewcZ5v1QLC6rRD9AWfqicKgQ",
  authDomain: "westocks-5184b.firebaseapp.com",
  databaseURL: "https://westocks-5184b-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "westocks-5184b",
  storageBucket: "westocks-5184b.firebasestorage.app",
  messagingSenderId: "265102905724",
  appId: "1:265102905724:web:52c5c7365df3929a32d4f9"
});
const db = firebase.database();
</script>

<style>
html,body{margin:0;height:100%;font-family:Arial;color:white}
body{display:flex;justify-content:center;align-items:center;
background:linear-gradient(270deg,#0f2027,#203a43,#2c5364);
background-size:600% 600%;animation:bg 18s ease infinite}
@keyframes bg{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.container{max-width:1000px;width:100%;background:rgba(0,0,0,.45);
padding:20px;border-radius:16px}
h1{text-align:center;letter-spacing:4px}
button{padding:6px 10px;border:none;border-radius:6px;font-weight:bold;cursor:pointer}
.buy{background:white;color:black}
.sell{background:#ffb3b3;color:black}
.toggle{background:rgba(255,255,255,.2);color:white}
.stock{margin-top:16px;padding:14px;background:rgba(255,255,255,.08);
border-radius:12px}
canvas{width:100%;height:140px;background:rgba(0,0,0,.3);border-radius:8px}
input{width:80px;padding:4px;border-radius:4px;border:none}
.profit{color:lime}
.loss{color:red}
#activeCount{text-align:center;margin-bottom:6px}
#message{margin-top:8px;opacity:.9}
ol{padding-left:20px}
.me{color:cyan;font-weight:bold}
</style>
</head>

<body>
<div class="container">
<h1>WESTOCKS</h1>

<div id="activeCount">Active Players: 0</div>

<div id="start" style="text-align:center">
<p>Demo only ‚Äî not real money</p>
<button class="buy" onclick="start()">Start Investing</button>
</div>

<div id="market" style="display:none">
Cash: $<span id="cash">1000.00</span><br>
Portfolio: $<span id="portfolioValue">1000.00</span>

<div class="stock">
<strong>üèÜ Leaderboard</strong>
<ol id="leaderboard"></ol>
</div>

<div id="message"></div>
<div id="stocks"></div>
</div>
</div>

<script>
/* USERNAME */
let username = localStorage.getItem("username");
if(!username){
  username = prompt("Choose a username") || "Guest"+Math.floor(Math.random()*1000);
  localStorage.setItem("username", username);
}

/* FIREBASE REFS */
const playersRef = db.ref("activePlayers");
const leaderboardRef = db.ref("leaderboard");

/* ACTIVE PLAYER */
const id = Math.random().toString(36).slice(2);
playersRef.child(id).set(true);
window.addEventListener("beforeunload",()=>{
  playersRef.child(id).remove();
  leaderboardRef.child(id).remove();
});
playersRef.on("value",s=>{
  activeCount.innerText="Active Players: "+s.numChildren();
});

/* DATA */
let cash = +localStorage.getItem("cash") || 1000;
const stocks={
  NOVA:{price:120,shares:+localStorage.getItem("NOVA")||0,history:[120],show:false},
  ORBX:{price:80,shares:+localStorage.getItem("ORBX")||0,history:[80],show:false},
  ZENT:{price:200,shares:+localStorage.getItem("ZENT")||0,history:[200],show:false}
};

function start(){
  start.style.display="none";
  market.style.display="block";
  render();
}

/* PRICE UPDATE */
setInterval(()=>{
  for(const s in stocks){
    let st=stocks[s];
    st.price=Math.max(1,+(st.price*(1+(Math.random()-0.5)*0.05)).toFixed(2));
    st.history.push(st.price);
    if(st.history.length>120)st.history.shift();
  }
  render();
},2500);

/* BUY / SELL */
function buy(sym){
  let amt=+document.getElementById("buy-"+sym).value;
  if(!amt||amt<=0||amt>cash)return msg("Invalid buy");
  let st=stocks[sym];
  let shares=amt/st.price;
  cash-=amt; st.shares+=shares;
  save(); render();
}
function sell(sym){
  let qty=+document.getElementById("sell-"+sym).value;
  let st=stocks[sym];
  if(!qty||qty<=0||qty>st.shares)return msg("Invalid sell");
  st.shares-=qty; cash+=qty*st.price;
  save(); render();
}

/* RENDER */
function render(){
  cashSpan.innerText=cash.toFixed(2);

  let total=cash;
  for(const s in stocks) total+=stocks[s].shares*stocks[s].price;
  portfolioValue.innerText=total.toFixed(2);

  leaderboardRef.child(id).set({name:username,value:total});

  let html="";
  for(const s in stocks){
    let st=stocks[s];
    let pl=st.shares*(st.price-st.history[0]);
    html+=`
    <div class="stock">
      <b>${s}</b> ‚Äî $${st.price}<br>
      Shares: ${st.shares.toFixed(3)}
      <span class="${pl>=0?'profit':'loss'}">${st.shares?pl.toFixed(2):""}</span><br><br>

      Buy $ <input id="buy-${s}" type="number">
      <button class="buy" onclick="buy('${s}')">Buy</button>

      Sell <input id="sell-${s}" type="number" step="0.01">
      <button class="sell" onclick="sell('${s}')">Sell</button>

      <button class="toggle" onclick="st.show=!st.show;render()">Graph</button>
      ${st.show?`<canvas id="g-${s}"></canvas>`:""}
    </div>`;
  }
  stocksDiv.innerHTML=html;

  for(const s in stocks) if(stocks[s].show) drawGraph(s);
}

/* GRAPH */
function drawGraph(sym){
  let c=document.getElementById("g-"+sym);
  c.width=c.parentElement.clientWidth;
  let ctx=c.getContext("2d"),d=stocks[sym].history;
  let min=Math.min(...d),max=Math.max(...d);
  ctx.clearRect(0,0,c.width,c.height);
  ctx.strokeStyle="white";ctx.beginPath();
  d.forEach((p,i)=>{
    let x=i/(d.length-1)*c.width;
    let y=c.height-(p-min)/(max-min+0.01)*c.height;
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  });
  ctx.stroke();
}

/* LEADERBOARD LISTENER */
leaderboardRef.on("value",snap=>{
  let arr=[];
  snap.forEach(c=>arr.push(c.val()));
  arr.sort((a,b)=>b.value-a.value);
  leaderboard.innerHTML=arr.slice(0,10).map((p,i)=>
    `<li class="${p.name===username?'me':''}">
      ${i==0?'ü•á':i==1?'ü•à':i==2?'ü•â':''}
      ${p.name}: $${p.value.toFixed(2)}
    </li>`
  ).join("");
});

/* HELPERS */
function save(){
  localStorage.setItem("cash",cash);
  for(const s in stocks)localStorage.setItem(s,stocks[s].shares);
}
function msg(t){
  message.innerText=t;
  setTimeout(()=>message.innerText="",1500);
}
</script>
</body>
</html>
